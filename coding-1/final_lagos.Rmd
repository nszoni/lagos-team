---
title: "Report on Snickers and Coca-Cola Prices"
author: "Lagos Team"
date: "7 November 2021"
geometry: margin=2cm
fontsize: 9pt
output:
  html_document:
    df_print: paged
  pdf_document:
---

```{r echo=FALSE, include=FALSE}
#knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
# Set graph size
#knitr::opts_chunk$set(echo = FALSE, out.width = "50%" )#fig.asp = 0.5, fig.width = 7, out.width = "90%" )

# Loading packages with pacman
if (!require("pacman")) {
  install.packages("pacman")
}

pacman::p_load(tidyverse, modelsummary, viridis,
               kableExtra, patchwork)

# Import data
df <- read.csv( 'https://raw.githubusercontent.com/nszoni/lagos-team/main/coding-1/data/Data_DA1_HW1_Lagos.csv' )

```



```{r echo=FALSE, include=FALSE}

### Data cleaning


df_clean <- df %>%
  mutate(google_rating = as.numeric(ifelse(google_rating!='N/A', substr(google_rating,1,3), NA)), # 1. Correct ratings and NAs
         number_of_reviews = as.numeric(ifelse(number_of_reviews=='N/A', NA, number_of_reviews)), # 2. Correct number of reviews NA
         shop_type_group = as.factor(ifelse(shop_type %in% c('Grocery', 'Gas station', "Supermarket", "Other"), "Big shop", "Small shop")), # 3. Create group for shop size
         is_discounted = as.factor(ifelse(is_discounted=='Y', 1, 0)), # 4. Replace booelan flags
         has_website = as.factor(ifelse(has_website=='Y', 1, 0)),
         longitude = as.numeric(longitude), # 5. Data casting
         latitude = as.numeric(latitude),
         google_rating = as.numeric(google_rating),
         number_of_reviews = as.integer(number_of_reviews),
         collection_date = as.POSIXct(collection_date),
         district = as.factor(district),
         item_name = ifelse(item_name == 'Coca Cola, 0.5l plastic bottle', 'Coke 0.5l', 'Snickers 50g')) %>% #5. Shortening item names
  filter(is_discounted == 0)   # not discounted

```

## Introduction

Can we encounter lower prices in the outer districts then in the inner disticts? What if we go farther from the city center? In order to examine these questions, product prices were collected from two districts of Budapest, the 13th and the 10th, representing the inner and outer parts of the city. Our objective with the data collection was to compare retail prices of two chosen products, Coca-Cola 500ml plastic bottle and Snickers 50gr chocolate bar in the two areas. In order to examine the differences in the price distributions, product tags were gathered from shops of different sizes including supermarkets, gas stations, as well as small local groceries.
Our data set and artifacts can be found on our [Github repo](https://github.com/nszoni/lagos-team/)


## Data Quality and Cleaning
The focus of our analysis is on the prices of the two products. In order to increase the comparability between the registered prices, we recorded if the prducts were offered at a discounted price. Items with discounted price were later excluded from our analysis (2 records). Additional data wrangling was done in order to prepare our data for analysis: missing values were encoded with the conventional NA, product names were shortened and all the variables in the dataset were assigned proper data type. Moreover, we created two groups from the recorder shop types, were we aggregated the shops into big supermarket chains and small local groceries categories.


## Descriptive Statistics
We are able to detect extreme values in our data set, which are items that are found within gas stations, which could potentially tell us that price rises based on momentum and desire, not strictly adhere to location of the district, but an amplification of sampling would be needed. 

Price for snickers is almost standardized in both districts, since the majority of data is concentrated in a certain price range, while for coke the range is wider, which makes us look into the distance as factor, for coke it seems that it does make an increase but not for snickers.


```{r, echo=FALSE, fig.align = 'center', }

#TODO: add kableExtra tabular form

  
# Transpose table
df_clean_wide <- df_clean %>%
  select(shop_name, item_name, district, price_huf) %>%
  spread(key = item_name, value = price_huf ) %>%
  arrange(district)
# Summary table
P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
Range <- function(x){max(x, na.rm = TRUE) - min(x, na.rm = TRUE)}
Missing <- function(x){sum(is.na(x))}
datasummary((`District` = as.factor(district))  * ( (`Coke 0.5l` = `Coke 0.5l`  ) + (`Snickers 50g` = `Snickers 50g`  ) )  ~
              N +
              Missing +
              Mean * Arguments(fmt = "%.1f") +
              Median +
              SD * Arguments(fmt = "%.2f") +
              Min  +
              Max  +
              Range +
              P05  +
              P95 ,
              fmt = 0,
              data = df_clean_wide,
              title = 'Descriptive statistics of product prices by district',
              notes = '') %>%
    kableExtra::kable_styling(latex_options = "hold_position", font_size = 8)



```

Intuitively the mean of both products are slightly higher in the inner 13th district. Also there is less variation in price of Snicker bars and more variation in the price of Coke. Those who are living in the inner city have to pay a larger entry price for Coke. The distribution of prices in teh inner district is shofted a bit considering the percentiles.

## Price Distribution 
The team decide to select a comibination of both histogram and density plot to show the distribution of prices for both the products in two districts. Histogram with a bin size of 10 was used becuase the price difference and frequecy of each price could be easily displayed, while desity plot shows how the distribution looks like, making it easier to visualise. 

```{r echo = F, warning=FALSE, fig.height = 3, fig.align="center"}

# Histograms

# Coke distribution
hist_fig_1 <- df_clean %>% filter(item_name=='Coke 0.5l') %>% 
                ggplot() + 
                geom_histogram(aes(price_huf, y=..density.., fill=district), binwidth = 30, alpha=0.6, position="dodge", bins = 10) +
                geom_density(aes(price_huf, y=..density.., color=district), position="identity", alpha=0.5) +
                labs(x = "Price (HUF)",
                     y = "Density",
                     title = "Coca Cola 0.5l bottle"
                     # caption = "Max price was HUF 449 & HUF 439 in district 10 & 13, respectively"
                     ) +
                scale_fill_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                scale_colour_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                theme_classic()


#Snickers distribution
hist_fig_2 <- df_clean %>% filter(item_name=='Snickers 50g') %>% 
                ggplot() + 
                geom_histogram(aes(price_huf, y=..density.., fill=district), binwidth = 30, alpha=0.6, position="dodge", bins = 10) +
                geom_density(aes(price_huf, y=..density.., color=district), position="identity", alpha=0.5) +
               labs(x = "Price (HUF)",
                     y = "Density",
                     title = "Snickers 50g bar"
                     # caption = "Max price was HUF 319 & HUF 299 in district 10 & 13, respectively"
                    ) +
                scale_fill_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                scale_colour_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                theme_classic()

hist_fig_1 + hist_fig_2 + plot_layout(guides = "collect")

```

```{r echo=F, warning=F, message=F, fig.show='hide'}
# hide
# Boxplots


df_clean %>% 
  filter(item_name == 'Snickers 50g') %>% 
  ggplot( aes(x = factor(district), y = price_huf)) +
    stat_boxplot(aes(group = factor(district)), geom = "errorbar", width = 0.2, color = "black", size = 0.3) +
    geom_boxplot(aes(group = factor(district)),  color = viridis(2, begin=0.2, end=0.8), fill = viridis(2, begin=0.2, end=0.8), size = 0.4, width = 0.15, alpha = 0.4) + # , outlier.shape = NA
    # geom_jitter(aes(color = factor(district)), position=position_jitter(0.1), size = 1.5, show.legend=F) +
    labs(x = "District",y = "Price",
         subtitle = "of Coca Cola 0.5l bottle",
       title = "Price desnity by district (HUF)",
       caption = "lagos-team") +
    scale_y_continuous(limits = c(100,350), breaks = seq(0,350,50)) +
    scale_color_viridis(discrete = TRUE, option = "D", begin = 0.2, end=0.8)+
    theme_bw() 


df_clean %>% 
  filter(item_name == 'Coke 0.5l') %>% 
  ggplot(aes(x = factor(district), y = price_huf)) +
    stat_boxplot(aes(group = factor(district)), geom = "errorbar", width = 0.2, color = "black", size = 0.3) +
    geom_boxplot(aes(group = factor(district)),  color = viridis(2, begin=0.2, end=0.8), fill = viridis(2, begin=0.2, end=0.8), size = 0.4, width =  0.15, alpha = 0.4) +  # , outlier.shape = NA
    # geom_jitter(aes(color = factor(district)), position=position_jitter(0.1), size = 1.5, show.legend=F) +
    labs(x = "District",y = "Price",
          subtitle = "of Snickers 50g bar",
      title = "Price desnity by district (HUF)",
       caption = "lagos-team") +
    scale_y_continuous(limits = c(200, 450), breaks = seq(0,450,50)) +
    scale_color_viridis(discrete = TRUE, option = "D", begin = 0.2, end=0.8)+
    theme_bw() 

```


## Price and Distance
To display the results of our second analysis, "relationship between price and distance from centre" a scator plots were used to display for both the product. For both products in District 13 the price increased as you moved away from the city centre, while in District 10 price decreased. 

```{r echo=F, fig.align='center', fig.height=3, warning=FALSE, message=FALSE}
# Scatterplots 

scatter_fig_1 <- df_clean %>% 
                    filter(item_name == 'Snickers 50g') %>% 
                    ggplot(aes(x = distance_from_city_centre_km, y = price_huf, color = factor(district))) +
                      geom_point( size = 3,  shape = 16, alpha = 0.9,  na.rm = TRUE) +
                      geom_smooth(method='lm',  linetype = "dashed", se = F) +
                      labs(x = "Distance from city centre (km)",y = "Price (HUF)",
                        title = "Coca Cola 0.5l bottle",
                        caption = "District 13 upward slop, District 10 downward slop") +
                      scale_colour_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                      theme_bw()


scatter_fig_2 <- df_clean %>% 
                    filter(item_name == 'Coke 0.5l') %>% 
                    ggplot(aes(x = distance_from_city_centre_km, y = price_huf, color = factor(district))) +
                      geom_point( size = 3,  shape = 16, alpha = 0.9,  na.rm = TRUE) +
                      geom_smooth(method='lm', linetype = "dashed", se = F) +
                      labs(x = "Distance from city centre (km)",y = "Price (HUF)",
                        title = "Snickers 50g bar",
                        caption = "District 13 upward slop, District 10 downward slop") +
                      scale_colour_viridis_d( begin = 0.2, end = 0.8, name = "District") +
                      theme_bw()

scatter_fig_1 + scatter_fig_2 + plot_layout(guides = "collect")
```

